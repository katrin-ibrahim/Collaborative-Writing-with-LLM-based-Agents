üî¨ SOFT CARDINALITY MATHEMATICAL INVESTIGATION
================================================================================
Investigating mathematical errors in HSR calculation...

üßÆ STORM SOFT CARDINALITY FORMULA ANALYSIS
================================================================================

üìñ STORM Paper Formula:
   card(A) = Œ£ count(Ai) where count(Ai) = 1 / Œ£ Sim(Ai, Aj)
   HSR = card(G ‚à© P) / card(G)
   where: card(G ‚à© P) = card(G) + card(P) - card(G ‚à™ P)

üîç TESTING SIMILARITY MATRIX PROPERTIES
   Input texts: ['History', 'Collections', 'Building']

   üìä Embedding shape: (3, 384)
   üìä Similarity matrix shape: (3, 3)

   üîç Mathematical Properties:
      Symmetric: True
      Diagonal (self-sim): min=57.6669, max=71.5292, mean=64.4835
      Off-diagonal: min=7.9667, max=18.3519, mean=14.3893
      Embedding norms: min=7.5939, max=8.4575, mean=8.0224

üö® INVESTIGATING PROBLEMATIC CASE
================================================================================
Generated (7): ['Hessisches_Landesmuseum_Darmstadt', 'History', 'Collections', 'Exhibitions', 'Education and Outreach', 'Research and Publications', 'Conclusion']
Reference (7): ['History', 'Building', 'Location', 'Renovations and extensions', 'Collections', 'Special exhibitions', 'References']

üìä STEP 1: Individual Set Analysis
   Reference set:
   üßÆ SOFT CARDINALITY DEBUG (Reference)
      Input embeddings shape: (7, 384)
      Similarity matrix:
        [0]  57.667  18.352  15.288   9.083  16.849  20.910  19.441
        [1]  18.352  64.254  30.807  29.309   7.967  22.761   9.638
        [2]  15.288  30.807  45.777  13.286  10.535  16.916  11.725
        [3]   9.083  29.309  13.286  65.774  12.924  24.718  19.311
        [4]  16.849   7.967  10.535  12.924  71.529  24.678  25.542
        [5]  20.910  22.761  16.916  24.718  24.678  70.207  17.610
        [6]  19.441   9.638  11.725  19.311  25.542  17.610  53.182
      Individual count calculations:
        [0] sim_sum=157.590469, count=0.006346
        [1] sim_sum=183.088425, count=0.005462
        [2] sim_sum=144.334274, count=0.006928
        [3] sim_sum=174.405212, count=0.005734
        [4] sim_sum=170.025375, count=0.005881
        [5] sim_sum=197.800385, count=0.005056
        [6] sim_sum=156.448776, count=0.006392
      Final soft cardinality: 0.041798
      Individual counts: ['0.006346', '0.005462', '0.006928', '0.005734', '0.005881', '0.005056', '0.006392']

   Generated set:
   üßÆ SOFT CARDINALITY DEBUG (Generated)
      Input embeddings shape: (7, 384)
      Similarity matrix:
        [0]  48.532  14.733  10.792  14.267   8.628   6.482   3.963
        [1]  14.733  57.667  16.849  19.313  11.755  17.086  11.698
        [2]  10.792  16.849  71.529  29.301  12.571  10.690   4.717
        [3]  14.267  19.313  29.301  73.778  20.012  17.221   4.967
        [4]   8.628  11.755  12.571  20.012  58.357  16.089   7.848
        [5]   6.482  17.086  10.690  17.221  16.089  30.032  11.509
        [6]   3.963  11.698   4.717   4.967   7.848  11.509  53.097
      Individual count calculations:
        [0] sim_sum=107.397133, count=0.009311
        [1] sim_sum=149.100906, count=0.006707
        [2] sim_sum=156.448959, count=0.006392
        [3] sim_sum=178.858948, count=0.005591
        [4] sim_sum=135.259872, count=0.007393
        [5] sim_sum=109.109451, count=0.009165
        [6] sim_sum=97.799545, count=0.010225
      Final soft cardinality: 0.054784
      Individual counts: ['0.009311', '0.006707', '0.006392', '0.005591', '0.007393', '0.009165', '0.010225']

üìä STEP 2: Union Analysis
   Union texts (14): ['History', 'Building', 'Location', 'Renovations and extensions', 'Collections', 'Special exhibitions', 'References', 'Hessisches_Landesmuseum_Darmstadt', 'History', 'Collections', 'Exhibitions', 'Education and Outreach', 'Research and Publications', 'Conclusion']
   üßÆ SOFT CARDINALITY DEBUG (Union)
      Input embeddings shape: (14, 384)
      Similarity matrix:
        [0]  57.667  18.352  15.288   9.083  16.849  20.910  19.441  14.733  57.667  16.849  19.313  11.755  17.086  11.698
        [1]  18.352  64.254  30.807  29.309   7.967  22.761   9.638  16.074  18.352   7.967  24.540  14.585   7.781   6.013
        [2]  15.288  30.807  45.777  13.286  10.535  16.916  11.725  16.489  15.288  10.535  19.819  17.041   9.451   5.982
        [3]   9.083  29.309  13.286  65.774  12.924  24.718  19.311  14.454   9.083  12.924  22.915  15.112   9.426   7.197
        [4]  16.849   7.967  10.535  12.924  71.529  24.678  25.542  10.792  16.849  71.529  29.301  12.571  10.690   4.717
        [5]  20.910  22.761  16.916  24.718  24.678  70.207  17.610  15.004  20.910  24.678  66.236  18.553  15.347   2.372
        [6]  19.441   9.638  11.725  19.311  25.542  17.610  53.182  12.025  19.441  25.542  19.768  16.456  18.547  14.688
        [7]  14.733  16.074  16.489  14.454  10.792  15.004  12.025  48.532  14.733  10.792  14.267   8.628   6.482   3.963
        [8]  57.667  18.352  15.288   9.083  16.849  20.910  19.441  14.733  57.667  16.849  19.313  11.755  17.086  11.698
        [9]  16.849   7.967  10.535  12.924  71.529  24.678  25.542  10.792  16.849  71.529  29.301  12.571  10.690   4.717
        [10]  19.313  24.540  19.819  22.915  29.301  66.236  19.768  14.267  19.313  29.301  73.778  20.012  17.221   4.967
        [11]  11.755  14.585  17.041  15.112  12.571  18.553  16.456   8.628  11.755  12.571  20.012  58.357  16.089   7.848
        [12]  17.086   7.781   9.451   9.426  10.690  15.347  18.547   6.482  17.086  10.690  17.221  16.089  30.032  11.509
        [13]  11.698   6.013   5.982   7.197   4.717   2.372  14.688   3.963  11.698   4.717   4.967   7.848  11.509  53.097
      Individual count calculations:
        [0] sim_sum=306.691376, count=0.003261
        [1] sim_sum=278.399750, count=0.003592
        [2] sim_sum=238.939529, count=0.004185
        [3] sim_sum=265.517548, count=0.003766
        [4] sim_sum=326.474335, count=0.003063
        [5] sim_sum=360.901398, count=0.002771
        [6] sim_sum=282.915070, count=0.003535
        [7] sim_sum=206.967163, count=0.004832
        [8] sim_sum=306.691315, count=0.003261
        [9] sim_sum=326.474335, count=0.003063
        [10] sim_sum=380.750000, count=0.002626
        [11] sim_sum=241.332977, count=0.004144
        [12] sim_sum=197.438812, count=0.005065
        [13] sim_sum=150.466309, count=0.006646
      Final soft cardinality: 0.053809
      Individual counts: ['0.003261', '0.003592', '0.004185', '0.003766', '0.003063', '0.002771', '0.003535', '0.004832', '0.003261', '0.003063', '0.002626', '0.004144', '0.005065', '0.006646']

üìä STEP 3: STORM Intersection Formula
   Formula: card(G ‚à© P) = card(G) + card(P) - card(G ‚à™ P)
   Calculation: 0.041798 + 0.054784 - 0.053809 = 0.042774

üìä STEP 4: Mathematical Constraint Validation
   Checking mathematical constraints:
      ‚ùå card(G ‚à© P) ‚â§ card(G): 0.042774 ‚â§ 0.041798
      ‚úÖ card(G ‚à© P) ‚â§ card(P): 0.042774 ‚â§ 0.054784
      ‚úÖ card(G ‚à© P) ‚â• 0: 0.042774 ‚â• 0.000000
      ‚ùå card(G ‚à™ P) ‚â• max(card(G), card(P)): 0.053809 ‚â• 0.054784

üìä STEP 5: HSR Calculation
   Raw HSR: 0.042774 / 0.041798 = 1.023340 (102.33%)
   Clamped HSR: 1.000000 (100.00%)
   ‚ùå MATHEMATICAL ERROR: HSR > 100% indicates intersection > reference cardinality

üîç TESTING EMBEDDING NORMALIZATION IMPACT
================================================================================
Original embeddings:
   üßÆ SOFT CARDINALITY DEBUG (Original)
      Input embeddings shape: (3, 384)
      Similarity matrix:
        [0]  57.667  16.849  19.441
        [1]  16.849  71.529  25.542
        [2]  19.441  25.542  53.182
      Individual count calculations:
        [0] sim_sum=93.956848, count=0.010643
        [1] sim_sum=113.920631, count=0.008778
        [2] sim_sum=98.164726, count=0.010187
      Final soft cardinality: 0.029608
      Individual counts: ['0.010643', '0.008778', '0.010187']

Normalized embeddings:
   üßÆ SOFT CARDINALITY DEBUG (Normalized)
      Input embeddings shape: (3, 384)
      Similarity matrix:
        [0]   1.000   0.262   0.351
        [1]   0.262   1.000   0.414
        [2]   0.351   0.414   1.000
      Individual count calculations:
        [0] sim_sum=1.613395, count=0.619811
        [1] sim_sum=1.676475, count=0.596490
        [2] sim_sum=1.765177, count=0.566516
      Final soft cardinality: 1.782816
      Individual counts: ['0.619811', '0.596490', '0.566516']

Comparison:
   Original cardinality: 0.029608
   Normalized cardinality: 1.782816
   Difference: 1.753208

üß™ TESTING ALTERNATIVE SOFT CARDINALITY FORMULAS
================================================================================
Test texts: ['History', 'Building', 'Collections']

Alternative formulas:
   STORM original: 0.032188
   Off-diagonal only: 0.102964
   Max similarity: 0.046884
   Average similarity: 0.096564

üîç INVESTIGATING UNION CALCULATION
================================================================================
Set A: ['History', 'Collections']
Set B: ['History', 'Building']
Expected union: {'Building', 'History', 'Collections'} (3 unique items)

   üßÆ SOFT CARDINALITY DEBUG Set A
      Input embeddings shape: (2, 384)
      Similarity matrix:
        [0]  57.667  16.849
        [1]  16.849  71.529
      Individual count calculations:
        [0] sim_sum=74.516144, count=0.013420
        [1] sim_sum=88.378426, count=0.011315
      Final soft cardinality: 0.024735
      Individual counts: ['0.013420', '0.011315']

   üßÆ SOFT CARDINALITY DEBUG Set B
      Input embeddings shape: (2, 384)
      Similarity matrix:
        [0]  57.667  18.352
        [1]  18.352  64.254
      Individual count calculations:
        [0] sim_sum=76.018860, count=0.013155
        [1] sim_sum=82.606262, count=0.012106
      Final soft cardinality: 0.025260
      Individual counts: ['0.013155', '0.012106']

   üßÆ SOFT CARDINALITY DEBUG Union
      Input embeddings shape: (4, 384)
      Similarity matrix:
        [0]  57.667  16.849  57.667  18.352
        [1]  16.849  71.529  16.849   7.967
        [2]  57.667  16.849  57.667  18.352
        [3]  18.352   7.967  18.352  64.254
      Individual count calculations:
        [0] sim_sum=150.535004, count=0.006643
        [1] sim_sum=113.194382, count=0.008834
        [2] sim_sum=150.535004, count=0.006643
        [3] sim_sum=108.924942, count=0.009181
      Final soft cardinality: 0.031301
      Individual counts: ['0.006643', '0.008834', '0.006643', '0.009181']

Cardinality comparison:
   card(A): 0.024735
   card(B): 0.025260
   card(A ‚à™ B): 0.031301
   Expected: card(A ‚à™ B) ‚â§ card(A) + card(B)
   Actual: 0.031301 ‚â§ 0.049995 = True
   Computed intersection: 0.018694

üîç Union embedding analysis:
   Union texts (with duplicates): ['History', 'Collections', 'History', 'Building']
   'History' self-similarity: 57.666931
   ‚ùå PROBLEM IDENTIFIED: Duplicate embeddings in union calculation!
   The union should deduplicate identical texts, but we're including duplicates.

================================================================================
üéØ INVESTIGATION SUMMARY
================================================================================
Key findings will be shown above. Look for:
1. Mathematical constraint violations (‚ùå)
2. Embedding normalization effects
3. Union calculation issues with duplicates
4. Alternative formula comparisons
